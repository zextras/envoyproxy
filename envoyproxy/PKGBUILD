# Please refer to the table below to check envoy and consul
# compatibility:
#   - https://www.consul.io/docs/connect/proxies/envoy

pkgname="envoyproxy"
pkgver="1.34.4"
pkgrel="1"
pkgdesc="A high performance, open source, general RPC framework that puts mobile and HTTP/2 first."
maintainer="Zextras SRL <packages@zextras.com>"
arch=('x86_64')
url="https://www.zextras.com"
license=("Apache-2.0")
section="utils"
provides=("getenvoy-envoy")
conflicts=("getenvoy-envoy")
source=(
  "https://archive.tetratelabs.io/envoy/download/v${pkgver}/envoy-v${pkgver}-linux-amd64.tar.xz"
)
makedepends__rocky_8=(
  'gcc-toolset-10-gcc'
  'gcc-toolset-10-gcc-c++'
  'zgit'
  'python312'
  'aspell-en'
  'libatomic'
  'libstdc++'
  'libstdc++-static'
  'libtool'
  'lld'
  'patch'
)
source__rocky_8=(
  "https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-linux-amd64"
  "https://github.com/envoyproxy/envoy/archive/refs/tags/v${pkgver}.tar.gz"
)
sha256sums=(
  'b821d0b0804d24c01f117858f09ab2f74819bdff16528e1c7ced835148432271'
)
sha256sums__rocky_8=(
  'SKIP'
  'SKIP'
)

package() {
  cd "${srcdir}/envoy-v${pkgver}-linux-amd64"
  install -Dm755 bin/envoy \
    "${pkgdir}/usr/bin/envoy"
}

build__rocky_8() {
  cd "${srcdir}/envoy-${pkgver}"
  python3 tools/github/write_current_source_version.py
  chmod +x ../bazelisk-linux-amd64
  source /opt/rh/gcc-toolset-10/enable
  ../bazelisk-linux-amd64 build envoy
}

package__rocky_8() {
  cd "${srcdir}/envoy-${pkgver}"
  install -Dm755 bazel-bin/source/exe/envoy-static \
    "${pkgdir}/usr/bin/envoy"
  strip "${pkgdir}/usr/bin/envoy"
}
