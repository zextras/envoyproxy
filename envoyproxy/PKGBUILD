# Please refer to the table below to check envoy and consul
# compatibility:
#   - https://www.consul.io/docs/connect/proxies/envoy

pkgname="envoyproxy"
pkgver="1.34.5"
pkgrel="1"
pkgdesc="A high performance, open source, general RPC framework that puts mobile and HTTP/2 first."
maintainer="Zextras SRL <packages@zextras.com>"
arch=('x86_64')
url="https://www.zextras.com"
license=("Apache-2.0")
section="utils"
provides=("getenvoy-envoy")
conflicts=("getenvoy-envoy")
source=(
  "https://github.com/envoyproxy/envoy/releases/download/v${pkgver}/envoy-contrib-${pkgver}-linux-x86_64"
)
makedepends__rocky_8=(
  'gcc-toolset-11-gcc'
  'gcc-toolset-11-gcc-c++'
  'gcc-toolset-11-binutils'
  'gcc-toolset-11-binutils-devel'
  "git"
  'python39'
)
source__rocky_8=(
  "https://github.com/bazelbuild/bazelisk/releases/download/v1.26.0/bazelisk-linux-amd64"
  "https://github.com/envoyproxy/envoy/archive/refs/tags/v${pkgver}.tar.gz"
)
sha256sums=(
  'SKIP'
)
sha256sums__rocky_8=(
  'SKIP'
  'SKIP'
)

package() {
  install -Dm755 ${srcdir}/envoy-contrib-${pkgver}-linux-x86_64 \
    "${pkgdir}/usr/bin/envoy"
}

build__rocky_8() {
  cd "${srcdir}/envoy-${pkgver}"

  {
    echo "build --cxxopt=-std=c++20"
    echo "build --host_cxxopt=-std=c++20"
    echo "build --action_env=BAZEL_CXXOPTS=-std=c++20"
    echo "build --action_env=CC=/opt/rh/gcc-toolset-11/root/usr/bin/gcc"
    echo "build --action_env=CXX=/opt/rh/gcc-toolset-11/root/usr/bin/g++"
    echo "build --action_env=AR=/opt/rh/gcc-toolset-11/root/usr/bin/ar"
    echo "build --action_env=LD=/opt/rh/gcc-toolset-11/root/usr/bin/ld"
    echo "build --action_env=STRIP=/opt/rh/gcc-toolset-11/root/usr/bin/strip"
    echo "build --action_env=PATH=/opt/rh/gcc-toolset-11/root/usr/bin:\$PATH"
    echo "build --linkopt=-fuse-ld=ld"
  } >> .bazelrc


  python3 tools/github/write_current_source_version.py
  chmod +x ../bazelisk-linux-amd64
  source /opt/rh/gcc-toolset-11/enable
  ../bazelisk-linux-amd64 build envoy \
    --action_env=BAZEL_CXXOPTS=-std=c++20 \
    --action_env=CC=/opt/rh/gcc-toolset-11/root/usr/bin/gcc \
    --action_env=CXX=/opt/rh/gcc-toolset-11/root/usr/bin/g++ \
    --action_env=AR=/opt/rh/gcc-toolset-11/root/usr/bin/ar \
    --action_env=LD=/opt/rh/gcc-toolset-11/root/usr/bin/ld \
    --action_env=STRIP=/opt/rh/gcc-toolset-11/root/usr/bin/strip \
    --action_env=PATH="/opt/rh/gcc-toolset-11/root/usr/bin:$PATH" \
    --cxxopt='-std=c++20' \
    --host_cxxopt='-std=c++20' \
    --linkopt='-fuse-ld=lld' \
    --verbose_failures \
    --sandbox_debug
}

package__rocky_8() {
  cd "${srcdir}/envoy-${pkgver}"
  install -Dm755 bazel-bin/source/exe/envoy-static \
    "${pkgdir}/usr/bin/envoy"
  strip "${pkgdir}/usr/bin/envoy"
}
