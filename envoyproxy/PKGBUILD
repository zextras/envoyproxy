# Please refer to the table below to check envoy and consul
# compatibility:
#   - https://www.consul.io/docs/connect/proxies/envoy

pkgname="envoyproxy"
pkgver="1.32.10"
pkgrel="1"
pkgdesc="A high performance, open source, general RPC framework that puts mobile and HTTP/2 first."
maintainer="Zextras SRL <packages@zextras.com>"
arch=('x86_64')
url="https://www.zextras.com"
license=("Apache-2.0")
section="utils"
provides=("getenvoy-envoy")
conflicts=("getenvoy-envoy")
source=(
  "https://github.com/envoyproxy/envoy/releases/download/v${pkgver}/envoy-contrib-${pkgver}-linux-x86_64"
)
makedepends__rocky_8=(
  'gcc-toolset-11-gcc'
  'gcc-toolset-11-gcc-c++'
  "git"
  'python39'
)
source__rocky_8=(
  "https://github.com/bazelbuild/bazelisk/releases/download/v1.24.0/bazelisk-linux-amd64"
  "https://github.com/envoyproxy/envoy/archive/refs/tags/v${pkgver}.tar.gz"
)
sha256sums=(
  'c2cce1c3fedeeab3e6cdc77aa2b89a5281d332abe299ddb71aeb29b6fc545f47'
)
sha256sums__rocky_8=(
  'c50d662dcec8832eca56be673f5f9eef31d66a82d47762f46c7a7cd63edfa314'
  '0338e6f2bb79f5efc84794b664b2218285f1e902fb640902ad676b22f1e1691b'
)

package() {
  install -Dm755 ${srcdir}/envoy-contrib-${pkgver}-linux-x86_64 \
    "${pkgdir}/usr/bin/envoy"
}

build__rocky_8() {
  cd "${srcdir}/envoy-${pkgver}"
  python3 tools/github/write_current_source_version.py
  chmod +x ../bazelisk-linux-amd64
  source /opt/rh/gcc-toolset-11/enable
  ../bazelisk-linux-amd64 build envoy
}

package__rocky_8() {
  cd "${srcdir}/envoy-${pkgver}"
  install -Dm755 bazel-bin/source/exe/envoy-static \
    "${pkgdir}/usr/bin/envoy"
  strip "${pkgdir}/usr/bin/envoy"
}
